name: publish-library

on:
  workflow_call:
    inputs:
      registryRepositoryName: 
        type: string  
        default: "core-helm-local"
      registryHost:
        type: string
        default: "farmer.jfrog.io"
      chartDirectory:
        type: string
        default: "./chart"  

    secrets:
      username: 
        required: true
      password:
        required: true        

jobs:

  get-chart-version:
    runs-on: ubuntu-latest
    outputs: 
      chartVersion: ${{ steps.get-semantic-version.outputs.group1 }}
    steps:
    - name: Check out the repo
      uses: actions/checkout@a81bbbf8298c0fa03ea29cdc473d45769f953675
        
    - name: SEMVER - Load
      id: read-properties
      uses: juliangruber/read-file-action@v1
      with:
        path: ${{ inputs.chartDirectory }}/Chart.yaml 
        
    - name: SEMVER - Determine.
      id: get-semantic-version
      uses: actions-ecosystem/action-regex-match@v2
      with:
        text: ${{ steps.read-properties.outputs.content }}
        regex: 'version: (.*)'    

  get-chart-name:
    runs-on: ubuntu-latest
    outputs: 
      chartName: ${{ steps.get-chart-name.outputs.group1 }}
    steps:
    - name: Check out the repo
      uses: actions/checkout@a81bbbf8298c0fa03ea29cdc473d45769f953675
        
    - name: SEMVER - Load
      id: read-properties
      uses: juliangruber/read-file-action@v1
      with:
        path: ${{ inputs.chartDirectory }}/Chart.yaml 
        
    - name: SEMVER - Determine.
      id: get-chart-name
      uses: actions-ecosystem/action-regex-match@v2
      with:
        text: ${{ steps.read-properties.outputs.content }}
        regex: 'name: (.*)'    
  
  publish:
    runs-on: ubuntu-latest
    needs:
    - get-chart-version
    - get-chart-name
    container:
      image: alpine/helm:3.1.1
    steps:
    - name: Check out the repo
      uses: actions/checkout@a81bbbf8298c0fa03ea29cdc473d45769f953675

    - name: INSTALL - Curl
      run: apk add curl

    - name: HELM - Package
      run: helm package ${{ inputs.chartDirectory }}

    - name: HELM - Publish
      run: curl -u ${{ secrets.username }}:${{ secrets.password }} -X PUT "https://${{ inputs.registryHost }}/artifactory/api/helm/${{ inputs.registryRepositoryName }}/${{ needs.get-chart-name.outputs.chartName }}-${{ needs.get-chart-version }}.tgz"